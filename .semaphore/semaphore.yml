version: v1.0
name: Performous Build on Ubuntu 18.04
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Ubuntu 18.04 Build
    dependencies: []
    task:
      prologue:
        commands:
          - echo "Installing Performous dependencies..."
          - sudo apt -y update
          - sudo apt -y install cmake gettext help2man clang gcc-7 g++-7 libepoxy-dev libsdl2-dev libcairo2-dev libpango1.0-dev librsvg2-dev libboost-all-dev libavcodec-dev libavformat-dev libswscale-dev libswresample-dev libpng-dev libjpeg-dev libxml++2.6-dev portaudio19-dev libopencv-dev libportmidi-dev libqrencode-dev libicu-dev libcpprest-dev libglm-dev libopenblas-dev libfftw3-dev
      jobs:
        - name: GCC-7 Build
          env_vars:
            - name: CC
              value: gcc-7
            - name: CXX
              value: g++-7
          commands:
            - checkout
            - git submodule init && git submodule update
            - mkdir build.gcc && cd build.gcc && cmake -DENABLE_WEBSERVER=ON -DCMAKE_VERBOSE_MAKEFILE=1 -DENABLE_WEBCAM=ON ..
            - make VERBOSE=1
        - name: Clang-6.0 Build
          env_vars:
            - name: CC
              value: clang
            - name: CXX
              value: clang++
          commands:
            - checkout
            - git submodule init && git submodule update
            - mkdir build.clang && cd build.clang && cmake -DENABLE_WEBSERVER=ON -DCMAKE_VERBOSE_MAKEFILE=1 -DENABLE_WEBCAM=ON ..
            - make VERBOSE=1
  - name: MacOS 10.14.6 Build
    dependencies: []
    task:
      agent:
        machine:
          type: a1-standard-4
          os_image: macos-mojave-xcode11
      secrets:
        - name: boost_portfile
      prologue:
        commands:
          - cache restore macports
          - echo "Installing MacPorts..."
          - curl -LJO https://github.com/macports/macports-base/releases/download/v2.6.2/MacPorts-2.6.2-10.14-Mojave.pkg
          - export PATH="/opt/local/bin:/opt/local/sbin:${PATH}"
          - sudo installer -pkg MacPorts-2.6.2-10.14-Mojave.pkg -target /
          - pushd /opt/
          - sudo curl -LJO https://github.com/performous/macos_ci_files/raw/master/macports-ci-stuff.tar && sudo tar -xvf ./macports-ci-stuff.tar
          - sudo mv /Users/semaphore/macos-ci-pubkey.pem /opt/local/share/macports/
          - cd portfiles && sudo portindex
          - popd
          - sudo port selfupdate
          - echo "Will serve ourselves a previously-built Boost binary package to save time"
          - sudo port install lighthttpd
          - lighttpd -D -f /opt/local/share/macports/macports-lighttpd.conf
          -echo "Installing Performous dependencies..."
          - sudo port -Np install autoconf automake boost libxmlxx3 libsdl2 -x11 harfbuzz harfbuzz-icu librsvg +quartz-x11 ffmpeg -x11 gdk-pixbuf2 -x11 glib2 +quartz-x11  cmake help2man libepoxy portaudio portmidi opencv icu libsigcxx2 openexr fontconfig freetype pango +quartz-x11 cairo +quartz-x11 libxml2 glm fftw-3-single graphviz +pangocairo-x11 gd2 -x11 | cat
          - port installed xorg*
          - sudo port -v install cpprestsdk | cat
          - curl https://bashupload.com/cpprestsdk.log --data-binary @/opt/local/var/macports/logs/_opt_local_var_macports_sources_rsync.macports.org_macports_release_tarballs_ports_www_cpprestsdk/cpprestsdk/main.log
          - cache store macports /opt/local
      jobs:
        - name: Generate app bundle
          commands:
            - checkout
            - git submodule init && git submodule update
            - cd osx-utils
            - sudo chmod +x ./performous-app-build.sh
            - ./performous-app-build.sh -D